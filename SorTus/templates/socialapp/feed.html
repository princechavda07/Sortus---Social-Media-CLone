{% extends 'socialapp/base.html' %}
{% load static %}

{% block title %} Your Feed {% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h4 class="mb-4">Your Feed</h4>

        {% for post in posts %}
        <div class="card mb-4 shadow-sm post-card">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <a href="{% url 'SocialApp:profile' post.author.username %}">
                        <img src="{{ post.author.profile.profile_pic.url }}" alt="{{ post.author.username }}'s profile picture" 
                             class="rounded-circle me-3" style="width: 45px; height: 45px; object-fit: cover;">
                    </a>
                    <div>
                        <a href="{% url 'SocialApp:profile' post.author.username %}" class="text-dark text-decoration-none fw-bold">{{ post.author.username }}</a>
                        <br>
                        <small class="text-muted">{{ post.created_at|timesince }} ago</small>
                    </div>

                    {% if post.author == request.user %}
                    <div class="dropdown ms-auto">
                        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{% url 'SocialApp:edit_post' post.id %}"><i class="fas fa-edit text-info me-2"></i>Edit</a></li>
                            <li><a class="dropdown-item" href="{% url 'SocialApp:delete_post' post.id %}"><i class="fas fa-trash text-danger me-2"></i>Delete</a></li>
                        </ul>
                    </div>
                    {% endif %}
                </div>

                <p class="card-text">{{ post.content|linebreaksbr }}</p>

                {% if post.image %}
                <a href="{% url 'SocialApp:post_detail' post.id %}">
                    <div class="post-image-container">
                        <img src="{{ post.image.url }}" alt="Post Image" class="post-image">
                    </div>
                </a>
                {% endif %}

                <hr>
                 <div class="d-flex justify-content-around text-muted">
                        <button class="btn btn-light flex-fill text-decoration-none like-button" 
                                data-post-id="{{ post.id }}" 
                                data-liked="{% if request.user in post.likes.all %}true{% else %}false{% endif %}"
                                {% if request.user in post.likes.all %} style="color: red;" {% endif %}>
                            <i class="fas fa-heart me-2"></i>
                            <span class="like-count">Like ({{ post.likes.count }})</span>
                        </button>
                        <a href="{% url 'SocialApp:post_detail' post.id %}" class="btn btn-light flex-fill mx-2 text-decoration-none">
                            <i class="fas fa-comment me-2"></i>
                            Comment ({{ post.comments.count }})
                        </a>
                        <a href="#" class="btn btn-light flex-fill text-decoration-none" onclick="sharePost(event, '{{ post.content|slice:":50"|safe }}...', '{{ post.get_absolute_url }}')">
                            <i class="fas fa-share me-2"></i>
                            Share
                        </a>

                        
                    </div>
            </div>
        </div>
        {% empty %}
        <div class="card">
            <div class="card-body text-center">
                <p class="text-muted">Your feed is empty. Follow some people or create your first post!</p>
                <a href="{% url 'SocialApp:create_post' %}" class="btn btn-primary mt-2">
                    <i class="fas fa-plus"></i> Create Post
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.like-button').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Prevent the default link behavior

                const postId = this.getAttribute('data-post-id');
                const isLiked = this.getAttribute('data-liked') === 'true';
                const url = `{% url 'SocialApp:like_post' 0 %}`.replace('0', postId);
                const likeCountSpan = this.querySelector('.like-count');

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                })
                .then(response => response.json())
                .then(data => {
                    // Update the button's appearance
                    if (data.liked) {
                        this.style.color = 'red';
                        this.setAttribute('data-liked', 'true');
                    } else {
                        this.style.color = 'black'; // Or remove style
                        this.setAttribute('data-liked', 'false');
                    }
                    
                    // Update the like count text
                    likeCountSpan.textContent = `Like (${data.likes_count})`;
                })
                .catch(error => console.error('Error:', error));
            });
        });
    });
</script>


<script>
    function sharePost(event, post_text, post_url) {
        // Prevent the default link behavior (page refresh/jump)
        event.preventDefault(); 

        // 1. Try to use the Web Share API
        if (navigator.share) {
            navigator.share({
                title: 'Check out this post!',
                text: post_text,
                url: post_url,
            })
            .then(() => console.log('Successful share'))
            .catch((error) => console.log('Error sharing', error));
        } else {
            // 2. Fallback: Copy URL to clipboard
            navigator.clipboard.writeText(post_url)
                .then(() => {
                    alert("Link copied to clipboard! You can now paste it to share.");
                })
                .catch(err => {
                    // 3. Final fallback if clipboard API fails
                    console.error('Failed to copy text: ', err);
                    alert("Web Share API not supported and link could not be copied. Please manually copy the link from the address bar.");
                });
        }
    }
</script>



{% endblock content %}



